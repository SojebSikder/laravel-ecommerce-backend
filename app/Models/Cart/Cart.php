<?php

namespace App\Models\Cart;

use App\Helper\SettingHelper;
use App\Helper\StringHelper;
use App\Models\Coupon\TempRedeem;
use App\Models\Product\Product;
use App\Models\Product\Variant\Variant;
use App\Models\User;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Cart extends Model
{
    use HasFactory;

    protected $appends = ['currency_sign', 'currency_code', 'subtotal'];

    // custom currency attribute
    public function getCurrencySignAttribute()
    {
        return SettingHelper::currency_sign();
    }

    // custom currency code attribute
    public function getCurrencyCodeAttribute()
    {
        return SettingHelper::currency_code();
    }

    public function user()
    {
        return $this->belongsTo(User::class, 'user_id');
    }

    public function product()
    {
        return $this->belongsTo(Product::class)->with('images');
    }

    public function variant()
    {
        return $this->belongsTo(Variant::class)->with('images');
    }


    public function getSubtotalAttribute()
    {
        $total = 0.0;
        if ($this->product->is_sale == 1) {
            // $total += StringHelper::discount($this->product->price, $this->product->discount);
            $total += ($this->product->new_price * $this->quantity);
        } else {
            $total += ($this->product->new_price * $this->quantity);
        }

        return $total;
    }

    // returns all products subtotal (for client side)
    public static function subtotal()
    {
        $carts = Cart::with('product')->where('user_id', auth('api')->user()->id)->get();


        $map = array_map(function ($cart) {

            $price = 0.0;

            if ($cart['product']['is_sale'] == 1) {
                // return ($price * $cart['quantity']) + StringHelper::discount($cart['product']['price'], $cart['product']['discount']);
                return $price + ($cart['product']['new_price'] * $cart['quantity']);
            } else {
                return $price + ((float) $cart['product']['new_price'] * $cart['quantity']);
            }
        }, $carts->toArray());

        $total = array_reduce($map, function ($prev, $curr) {
            return (float)$prev + (float)$curr;
        }, 0.0);
        return $total;
    }

    // check cart if amount or quantity less or exmpty
    public function checkCouponOnCart()
    {
        $temp_redeems = TempRedeem::where('user_id', auth('api')->user()->id)->get();

        if ($temp_redeems) {
            foreach ($temp_redeems as $temp_redeem) {
                if ($temp_redeem->coupon->method == "code") {
                    //Minimum purchase requirements
                    if ($temp_redeem->coupon->min_type == "amount") {
                        if (Cart::subtotal() < $temp_redeem->coupon->min_amount) {
                            TempRedeem::where('id', $temp_redeem->id)->first()->delete();
                        }
                    } else if ($temp_redeem->coupon->min_type == "quantity") {
                        $cartCount = Cart::where('user_id', auth('api')->user()->id)->get()->count();
                        if ($cartCount < $temp_redeem->coupon->min_qnty) {
                            TempRedeem::where('id', $temp_redeem->id)->first()->delete();
                        }
                    }
                }
            }
        }
        return;
    }
    // returns coupon discounted price
    public static function coupon_price()
    {
        $temp_redeems = TempRedeem::where('user_id', auth('api')->user()->id)->get();

        $amountArray = [];

        foreach ($temp_redeems as $temp_redeem) {
            if ($temp_redeem->coupon->method == "code") {
                array_push($amountArray, [
                    'amount' => (float) $temp_redeem->coupon->amount,
                    'amount_type' => $temp_redeem->coupon->amount_type
                ]);
            }
        }

        return $amountArray;
    }

    // return total price of order (for client side)
    public static function order_total()
    {
        $coupon_prices = static::coupon_price();
        $subtotal = static::subtotal();

        if ($coupon_prices) {
            $total = 0.0;
            foreach ($coupon_prices as $coupon_price) {
                if ($coupon_price['amount_type'] == 'percentage') {
                    // $total - (($request->input('price') * $discount) / 100);
                    $total += ($subtotal * (float) $coupon_price['amount']) / 100;
                } else {
                    $total += (float) $coupon_price['amount'];
                }
            }
            return number_format($subtotal - $total, 1, '.', '');
        } else {
            return $subtotal;
        }
    }
}
